# Instructions for merging data on hive

Make sure in the directory input, tax.csv, transportation.csv, and water_quality.csv are in same directory. The results of these files are generated by the other code. 

1. Put files on hdfs 

***Note***: In /input, there is a bash file that can do input files for hdfs. From step 2, it has to be manually placed in.

- Delete directories
hdfs dfs -rm -r output_final
hdfs dfs -rm -r tax
hdfs dfs -rm -r transport
hdfs dfs -rm -r water

- Make a directory for each input file
hdfs dfs -mkdir tax
hdfs dfs -mkdir transport
hdfs dfs -mkdir water

cd input

hdfs dfs -put tax tax
hdfs dfs -put transportation transport
hdfs dfs -put water_quality water

2. Go onto hive
- beeline
- !connect jdbc:hive2://babar.es.its.nyu.edu:10000/;
- use (Your Net ID);

3. Create tables

**IMPORTANT**: Remember to substitute your net id when creating the table

- Create transport table

create external table transport(state string, county string, bridges int, residents int, pctMediumToFairBridges double, pctPoorBridges double, milesFreightRailroad double, roadsAcceptable double, countyArea double) row format delimited fields terminated by ',' location '/user/(your net id)/transport';

- Create Tax table

create external table tax(state string, county string,taxRespondents double,stateLocalIncomeTax double, realEstateTax double) row format delimited fields terminated by ',' location '/user/(your net id)/tax';

- Create Water Quality table

- create external table water(state string, county string, populationServed int, waterSystems int) row format delimited fields terminated by ',' location '/user/(your net id)/water';

At this point there should be three tables

4. Combine Tables

- Combine tax and transport tables to create taxtransport

create table taxtransport as select transport.*, tax.taxRespondents, tax.stateLocalIncomeTax, tax.realEstateTax from transport left outer join tax on (transport.state = tax.state and transport.county = tax.county);

- Combine taxtransport and water tables to create final

create table final as select taxtransport.*, water.populationserved, water.watersystems from taxtransport left outer join water on (taxtransport.state = water.state and taxtransport.county = water.county);

5. Do analytics on combined

create table final_analytic 
as 
select
state,
county,
residents,
pctmediumtofairbridges/pctpoorbridges as ratiofairtopoor,
milesfreightrailroad/countyarea as freightpersqmile,
roadsacceptable,
populationserved/watersystems as watersyspercapita,
realestatetax/countyarea as realestatetaxpersqmile
from final;

6. Export hive table to hdfs to local

***NOTE***: The first line has to run in beeline. The rest is done locally.

INSERT OVERWRITE DIRECTORY '/user/jc8017/output_final' 
ROW FORMAT DELIMITED FIELDS TERMINATED BY ',' 
LINES TERMINATED BY "\n" 
SELECT * FROM final_analytic;

hdfs dfs -copyToLocal output_final/000000_0 ./output
mv ./output/000000_0 ./output/final_output



# Misc

- Table column names

transport.hash transport.state transport.county transport.numberofbridges transport.numberofresidents transport.pctofmediumtofairconditionbridges transport.pctofpoorconditionbridges transport.primaryandcommercialairports transport.routemilesoffreightrailroad transport.routemilesofpassengerrailroadandrailtransit transport.roadsacceptable 

tax.hash,tax.state tax.county,tax.numberofreturns,tax.adjustgrossincome,tax.totalincomeamount,tax.salariesandwagesamount,tax.stateandlocalincometaxamount,tax.realestatetaxes,tax.totaltaxespaid,tax.residentialenergytaxcreditamount

water.hash, water.state, water.county, water.populationserved, water.watersystems, water.citiesserved, water.watersystemspercapita

Okay columns

1. 
@Mert Alev
 
- Number of residents, Pct of medium to fair bridges, Pct of poor bridges, Route Miles Of Freight Data, Roads Acceptable, Land Area

2. 
@Anand Tyagi

- Number Of Respondents, State and Local Income Tax, Real Estate Tax

3. @Justin
- Population Served, Water Systems